<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eDNA Biodiversity Analysis Prototype</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <!-- Topbar -->
    <div class="absolute top-4 right-8 flex items-center gap-4 z-20">
        <span class="text-sm text-gray-600">Welcome, <b>{{ username }}</b></span>
        <form id="logout-form" method="post" action="/api/logout">
            <button type="submit" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">Logout</button>
        </form>
    </div>
    <!-- Main Card -->
    <div class="max-w-4xl w-full bg-white shadow-lg rounded-lg p-8 mt-20">
        <!-- Header -->
        <h1 class="text-3xl font-bold text-center mb-6">eDNA Biodiversity Analysis Pipeline</h1>
        <p class="text-center text-gray-600 mb-8">Upload raw sequencing data (.fastq or .fasta) to analyze taxonomy and biodiversity using AI-driven unsupervised learning.</p>

        <!-- Upload Section -->
        <div id="upload-section" class="text-center">
            <label for="file-upload" class="cursor-pointer bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition">
                Start Analysis
            </label>
            <input id="file-upload" type="file" class="hidden" accept=".fastq,.fasta">
            <p class="mt-4 text-gray-500">Click to start the analysis pipeline.</p>
        </div>

        <!-- Progress Section (Hidden initially) -->
        <div id="progress-section" class="hidden">
            <h2 class="text-2xl font-semibold mb-4">Analysis in Progress</h2>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%;"></div>
            </div>
            <div id="log" class="bg-gray-100 p-4 rounded-lg h-40 overflow-y-auto text-sm text-gray-700"></div>
        </div>

        <!-- Results Dashboard (Hidden initially) -->
        <div id="results-section" class="hidden">
            <h2 class="text-2xl font-semibold mb-6">Analysis Results</h2>
            <!-- Summary Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <h3 class="font-medium text-lg">Identified Taxa Count</h3>
                    <p id="identified-count" class="text-2xl font-bold"></p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <h3 class="font-medium text-lg">Novel Taxa Count</h3>
                    <p id="novel-count" class="text-2xl font-bold"></p>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg text-center">
                    <h3 class="font-medium text-lg">Shannon Diversity Index</h3>
                    <p id="shannon-index" class="text-2xl font-bold"></p>
                </div>
            </div>
            <!-- Abundance Chart -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Relative Abundance of Top Taxa</h3>
                <canvas id="abundance-chart" height="200"></canvas>
            </div>
            <!-- Visualizations -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-4">Key Visualizations</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-2 border rounded-lg shadow-sm">
                        <img id="latent-space-plot" src="" alt="VAE Latent Space Plot" class="w-full h-auto rounded-lg">
                    </div>
                    <div class="p-2 border rounded-lg shadow-sm">
                        <img id="kmer-heatmap-plot" src="" alt="K-mer Heatmap" class="w-full h-auto rounded-lg">
                    </div>
                </div>
            </div>
            <!-- Detailed Table -->
            <div>
                <h3 class="text-xl font-semibold mb-4">Detailed Taxa Table</h3>
                <input id="table-search" type="text" placeholder="Search taxa..." class="w-full p-2 mb-4 border rounded-lg">
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left">Taxon ID</th>
                                <th class="p-2 text-left">Classification</th>
                                <th class="p-2 text-left">Abundance (Reads)</th>
                                <th class="p-2 text-left">Type</th>
                            </tr>
                        </thead>
                        <tbody id="taxa-table-body"></tbody>
                    </table>
                </div>
            </div>
            <!-- Restart Button -->
            <div class="text-center mt-8">
                <button id="restart-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded-lg font-semibold transition">Restart Analysis</button>
            </div>
        </div>
    </div>
    <script>
        // Handle logout
        document.getElementById('logout-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/';
        });

        const stages = [
            'Simulating File Upload...',
            'Sending request to backend...',
            'Analysis in progress...',
            'Generating visualizations...',
            'Analysis completed.'
        ];
        
        function appendLog(message) {
            const log = document.getElementById('log');
            log.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
            log.scrollTop = log.scrollHeight;
        }

        function clearDashboard() {
            document.getElementById('identified-count').textContent = "";
            document.getElementById('novel-count').textContent = "";
            document.getElementById('shannon-index').textContent = "";
            document.getElementById('taxa-table-body').innerHTML = "";
            document.getElementById('table-search').value = "";
            document.getElementById('latent-space-plot').src = "";
            document.getElementById('kmer-heatmap-plot').src = "";
            const chartArea = document.getElementById('abundance-chart').getContext('2d');
            if (window.abundanceChart) {
                window.abundanceChart.destroy();
            }
        }

        async function startAnalysis() {
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('log').innerHTML = "";
            clearDashboard();

            let progress = 0;
            const progressBar = document.getElementById('progress-bar');
            
            // Step 1: Simulate progress and send request
            stages.forEach((stage, index) => {
                setTimeout(() => {
                    appendLog(stage);
                    progress = ((index + 1) / stages.length) * 100;
                    progressBar.style.width = `${progress}%`;
                }, (index) * 1000);
            });
            
            try {
                const response = await fetch('/api/analyze', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    setTimeout(() => showResults(data), 1000);
                } else {
                    appendLog(`Error: ${data.error}`);
                }
            } catch (error) {
                appendLog(`An error occurred: ${error.message}`);
            }
        }
        
        function showResults(data) {
            document.getElementById('progress-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');

            const summary = data.taxonomic_summary;
            const metrics = data.biodiversity_metrics;
            const taxaDetails = data.taxa_details;

            // Populate summary
            document.getElementById('identified-count').textContent = summary.identified_taxa;
            document.getElementById('novel-count').textContent = summary.novel_taxa;
            document.getElementById('shannon-index').textContent = metrics.shannon_diversity_index.toFixed(2);
            
            // Populate table
            const tableBody = document.getElementById('taxa-table-body');
            tableBody.innerHTML = "";
            taxaDetails.forEach(taxon => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2 border">${taxon.cluster_id}</td>
                    <td class="p-2 border">${taxon.taxon_name}</td>
                    <td class="p-2 border">${taxon.abundance}</td>
                    <td class="p-2 border ${taxon.status === 'Novel' ? 'text-red-500 font-bold' : ''}">${taxon.status}</td>
                `;
                tableBody.appendChild(row);
            });

            // Table search
            const searchInput = document.getElementById('table-search');
            searchInput.oninput = function () {
                const filter = searchInput.value.toLowerCase();
                Array.from(tableBody.rows).forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(filter) ? '' : 'none';
                });
            };

            // Abundance Chart
            const topTaxa = taxaDetails.slice(0, 10);
            const totalAbundance = taxaDetails.reduce((sum, d) => sum + d.abundance, 0);
            const ctx = document.getElementById('abundance-chart').getContext('2d');
            if (window.abundanceChart) window.abundanceChart.destroy();
            window.abundanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topTaxa.map(d => d.taxon_name),
                    datasets: [{
                        label: 'Relative Abundance',
                        data: topTaxa.map(d => ((d.abundance / totalAbundance) * 100).toFixed(2)),
                        backgroundColor: topTaxa.map(d => d.status === 'Novel' ? 'rgba(255, 99, 132, 0.7)' : 'rgba(54, 162, 235, 0.7)'),
                        borderColor: topTaxa.map(d => d.status === 'Novel' ? 'rgb(255, 99, 132)' : 'rgb(54, 162, 235)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Percentage (%)' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${context.raw}% (${topTaxa[context.dataIndex].abundance} reads)`
                            }
                        }
                    }
                }
            });
            
            // Update image sources
            document.getElementById('latent-space-plot').src = "/plots/latent_space_clusters.png";
            document.getElementById('kmer-heatmap-plot').src = "/plots/kmer_heatmap.png";
        }

        document.getElementById('file-upload').addEventListener('change', startAnalysis);

        // Restart simulation button
        document.getElementById('restart-btn').addEventListener('click', function () {
            clearDashboard();
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('progress-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
        });

    </script>
</body>
</html>
